Bluepill.application("<%= fetch(:jobs_app_name) %>", :log_file => "<%= shared_path.join('log', 'bluepill_jobs.log') %>", :foreground => true) do |app|
  app.process("tasker") do |process|
    pid_file                    = "<%= fetch(:webserver_socket_path) %>/jobs.pid"
    current_path                = "<%= current_path %>"
    rails_env                   = "<%= fetch(:rails_env) %>"
    jobs_tasker                 = "<%= shared_path.join('bundle', 'bin', 'rabid_jobs_tasker') %> " +
      "--verbosity debug " +
      "--rails_root #{current_path} " +
      "--environment #{rails_env} " +
      "--pid #{pid_file}"
    process.daemonize           = true
    process.pid_file            = pid_file
    process.working_dir         = current_path
    process.environment         = {"BUNDLE_GEMFILE" => "#{current_path}/Gemfile",
                                   "RAILS_ROOT"     => current_path}
    process.start_command       = "#{jobs_tasker} --maxworkers 3"
    process.stop_command        = "#{jobs_tasker} --shutdown"
    process.uid = process.gid   = '<%= fetch(:webserver_username) %>'
    process.start_grace_time    = 30.seconds
    process.stop_grace_time     = 30.seconds
    process.restart_grace_time  = 60.seconds
    process.checks :mem_usage, :every => 30.seconds, :below => 150.megabytes, :times => [3,4], :fires => :stop
    process.checks :cpu_usage, :every => 30.seconds, :below => 20, :times => [3,4], :fires => :stop
  end
end
